<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeActor 3D - ‰ª£Á†ÅÂ∫ìÊãü‰∫∫ÂåñÂèØËßÜÂåñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            color: #fff;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }
        #info-panel {
            position: fixed;
            top: 180px;
            right: 20px;
            width: 320px;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 20px;
            color: #fff;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateX(50px);
            z-index: 999;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        #info-panel.visible {
            transform: translateX(0);
            opacity: 1;
        }
        #legend-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-width: 320px;
        }
        .legend-section {
            margin-bottom: 16px;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
            color: #ddd;
        }
        .legend-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #fff;
            z-index: 1000;
        }
        .controls-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(26, 26, 46, 0.9);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            color: #aaa;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">üé≠ Âä†ËΩΩ‰∏≠...</div>

    <div id="canvas-container"></div>

    <div id="info-panel">
        <div class="panel-header">
            <div style="font-size: 16px; font-weight: bold; color: #FFD700;">
                <span id="character-icon">üé≠</span>
                <span id="character-name"></span>
            </div>
            <div style="font-size: 14px; opacity: 0.7;" id="character-role"></div>
        </div>

        <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; opacity: 0.6;">PERSONALITY</div>
            <div style="font-size: 14px;" id="character-personality"></div>
        </div>

        <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; opacity: 0.6;">TRAITS</div>
            <div style="display: flex; flex-wrap: wrap; gap: 6px;" id="character-traits"></div>
        </div>

        <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; opacity: 0.6;">HEALTH STATUS</div>
            <div style="display: flex; align-items: center; gap: 8px;" id="character-health"></div>
        </div>

        <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; opacity: 0.6;">STATISTICS</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;" id="character-stats"></div>
        </div>

        <div id="character-backstory" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);"></div>
    </div>

    <div id="legend-panel">
        <div class="legend-section">
            <div class="legend-title">Relationship Types</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF6B6B;"></div>
                    <span>Best Friends</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9B59B6;"></div>
                    <span>Unrequited Love</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF4500;"></div>
                    <span>Toxic Relationship</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498DB;"></div>
                    <span>Secret Admirer</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ECC71;"></div>
                    <span>Fan Following</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #95A5A6;"></div>
                    <span>Contract Relationship</span>
                </div>
            </div>
        </div>

        <div class="legend-section">
            <div class="legend-title">Health Levels</div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <div style="text-align: center;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #2ECC71; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px;">
                        <span style="font-size: 18px; color: #fff;">‚úì</span>
                    </div>
                    <span style="font-size: 12px;">Excellent</span>
                </div>
                <div style="text-align: center;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #00BCD4; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px;">
                        <span style="font-size: 18px; color: #fff;">‚úì</span>
                    </div>
                    <span style="font-size: 12px;">Good</span>
                </div>
                <div style="text-align: center;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #F1C40F; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px;">
                        <span style="font-size: 18px; color: #fff;">!</span>
                    </div>
                    <span style="font-size: 12px;">Fair</span>
                </div>
                <div style="text-align: center;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #FF6B00; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px;">
                        <span style="font-size: 18px; color: #fff;">‚ö†</span>
                    </div>
                    <span style="font-size: 12px;">Poor</span>
                </div>
                <div style="text-align: center;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #DC2626; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px;">
                        <span style="font-size: 18px; color: #fff;">üî•</span>
                    </div>
                    <span style="font-size: 12px;">Critical</span>
                </div>
            </div>
        </div>

        <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 11px; opacity: 0.8;">
                <strong>üí° Double-click</strong> character to toggle selection
            </div>
            <div style="font-size: 11px; opacity: 0.8;">
                <strong>üñ±Ô∏è Drag</strong> selected character to reposition
            </div>
        </div>
    </div>

    <div class="controls-hint">
        üñ±Ô∏è Drag to rotate | üîç Scroll to zoom
    </div>

    <script type="importmap">
        import * as THREE from 'https://cdn.skypack.dev/three@0.160.0/build/three.module.js';
        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    </script>

    <script type="module">
        // Character data
        const characters = [];
        const relationships = [];

        // Three.js variables
        let scene, camera, renderer, controls;
        let characterMeshes = [];
        let relationLines = [];

        // UI Elements
        const loadingElement = document.getElementById('loading');
        const infoPanel = document.getElementById('info-panel');

        async function init() {
            try {
                // Try to connect to local server for analysis data
                const response = await fetch('http://localhost:5173/api/result');
                if (response.ok) {
                    const result = await response.json();
                    initializeVisualization(result);
                } else {
                    throw new Error('Could not connect to server');
                }
            } catch (error) {
                console.log('Using demo data...');
                // Demo data
                initializeVisualization({
                    characters: [
                        { id: 'main', name: 'Main Process', type: 'HEROIC', color: 0xef4444, position: { x: 0, y: 0, z: 0 }, health: 92, traits: ['Leader', 'Brave'], role: 'Core' },
                        { id: 'renderer', name: 'Renderer', type: 'RELIABLE', color: 0x3b82f6, position: { x: -3, y: 0, z: 0 }, health: 88, traits: ['Stable', 'Wise'], role: 'UI' },
                        { id: 'bridge', name: 'IPC Bridge', type: 'HELPFUL', color: 0x2ecc71, position: { x: 0, y: 0, z: -3 }, health: 85, traits: ['Helper', 'Kind'], role: 'Bridge' },
                    ],
                    relationships: [
                        { from: 'main', to: 'renderer', type: 'best_friend', strength: 0.9 },
                        { from: 'main', to: 'bridge', type: 'contract', strength: 0.8 },
                        { from: 'renderer', to: 'bridge', type: 'best_friend', strength: 0.7 },
                    ]
                });
            }

            loadingElement.style.display = 'none';
        }

        function initializeVisualization(result) {
            // Store data
            characters.length = 0;
            characters.push(...result.characters);
            relationships.length = 0;
            relationships.push(...result.relationships);

            // Initialize Three.js
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            scene.fog = new THREE.Fog(0x1a1a2e, 20, 80);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 30);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = false;
            controls.maxPolarAngle = Math.PI / 2;
            controls.minDistance = 10;
            controls.maxDistance = 100;

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
            mainLight.position.set(20, 30, 20);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 2048;
            mainLight.shadow.mapSize.height = 2048;
            scene.add(mainLight);

            // Ground
            const groundGeo = new THREE.PlaneGeometry(100, 100);
            const groundMat = new THREE.MeshStandardMaterial({
                color: 0x1a1a2e,
                roughness: 0.8,
                metalness: 0.2,
            });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            scene.add(ground);

            const gridHelper = new THREE.GridHelper(100, 50, 0x444466, 0x333355);
            scene.add(gridHelper);

            // Create characters
            createCharacters();

            // Create relationships
            createRelationships();

            // Events
            window.addEventListener('resize', onWindowResize);
            renderer.domElement.addEventListener('click', onClick);
            renderer.domElement.addEventListener('dblclick', onDoubleClick);

            // Animation loop
            animate();
        }

        function createCharacters() {
            characters.forEach(char => {
                const group = new THREE.Group();
                group.userData = { ...char, isSelected: false, isDraggable: false };

                // Create character based on type
                switch (char.type) {
                    case 'HEROIC':
                        createHeroicCharacter(group, char);
                        break;
                    case 'RELIABLE':
                        createReliableCharacter(group, char);
                        break;
                    case 'HELPFUL':
                        createHelpfulCharacter(group, char);
                        break;
                    default:
                        createDefaultCharacter(group, char);
                }

                group.position.set(char.position.x, 0, char.position.z);
                scene.add(group);
                characterMeshes.push(group);
            });
        }

        function createHeroicCharacter(group, char) {
            const bodyGeo = new THREE.CapsuleGeometry(0.5, 1.2, 8, 16);
            const bodyMat = new THREE.MeshToonMaterial({ color: char.color });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 1;
            body.castShadow = true;
            group.add(body);

            const headGeo = new THREE.SphereGeometry(0.5, 16, 16);
            const headMat = new THREE.MeshToonMaterial({ color: 0xFFE0BD });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 2;
            head.castShadow = true;
            group.add(head);

            // Eyes - BIG and VISIBLE (0.15 radius)
            const eyeGeo = new THREE.SphereGeometry(0.15, 16, 16);
            const eyeMat = new THREE.MeshBasicMaterial({ color: 0x333333 });
            const leftEye = new THREE.Mesh(eyeGeo, eyeMat);
            leftEye.position.set(-0.2, 2.1, 0.5);
            group.add(leftEye);
            const rightEye = new THREE.Mesh(eyeGeo, eyeMat);
            rightEye.position.set(0.2, 2.1, 0.5);
            group.add(rightEye);

            // Cape
            const capeGeo = new THREE.PlaneGeometry(1.2, 1.5);
            const capeMat = new THREE.MeshToonMaterial({ color: 0xCC0000, side: THREE.DoubleSide });
            const cape = new THREE.Mesh(capeGeo, capeMat);
            cape.position.set(0, 1.2, -0.3);
            cape.rotation.y = Math.PI;
            group.add(cape);
        }

        function createReliableCharacter(group, char) {
            const bodyGeo = new THREE.CylinderGeometry(0.7, 0.8, 1.5, 8);
            const bodyMat = new THREE.MeshToonMaterial({ color: char.color });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 0.75;
            body.castShadow = true;
            group.add(body);

            const headGeo = new THREE.SphereGeometry(0.5, 16, 16);
            const headMat = new THREE.MeshToonMaterial({ color: 0xFFE0BD });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 1.75;
            head.castShadow = true;
            group.add(head);

            // Glasses
            const glassesGeo = new THREE.TorusGeometry(0.12, 0.02, 8, 16);
            const glassesMat = new THREE.MeshBasicMaterial({ color: 0x333333 });
            const leftGlass = new THREE.Mesh(glassesGeo, glassesMat);
            leftGlass.position.set(-0.15, 1.8, 0.4);
            group.add(leftGlass);
            const rightGlass = new THREE.Mesh(glassesGeo, glassesMat);
            rightGlass.position.set(0.15, 1.8, 0.4);
            group.add(rightGlass);

            // Eyes - VISIBLE (0.15 radius)
            const eyeGeo = new THREE.SphereGeometry(0.15, 8, 8);
            const eyeMat = new THREE.MeshBasicMaterial({ color: 0x333333 });
            const leftEye = new THREE.Mesh(eyeGeo, eyeMat);
            leftEye.position.set(-0.15, 1.8, 0.45);
            group.add(leftEye);
            const rightEye = new THREE.Mesh(eyeGeo, eyeMat);
            rightEye.position.set(0.15, 1.8, 0.45);
            group.add(rightEye);

            // Beard
            const beardGeo = new THREE.ConeGeometry(0.3, 0.4, 8);
            const beardMat = new THREE.MeshToonMaterial({ color: 0xCCCCCC });
            const beard = new THREE.Mesh(beardGeo, beardMat);
            beard.position.set(0, 1.4, 0.2);
            beard.rotation.x = 0.5;
            group.add(beard);

            // Book
            const bookGeo = new THREE.BoxGeometry(0.6, 0.1, 0.8);
            const bookMat = new THREE.MeshToonMaterial({ color: 0x8B4513 });
            const book = new THREE.Mesh(bookGeo, bookMat);
            book.position.set(0.8, 0.8, 0);
            book.rotation.y = -0.3;
            group.add(book);
        }

        function createHelpfulCharacter(group, char) {
            const bodyGeo = new THREE.SphereGeometry(0.4, 16, 16);
            const bodyMat = new THREE.MeshToonMaterial({ color: char.color });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 0.8;
            body.scale.y = 1.5;
            body.castShadow = true;
            group.add(body);

            const headGeo = new THREE.SphereGeometry(0.45, 16, 16);
            const headMat = new THREE.MeshToonMaterial({ color: 0xFFE0BD });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 1.7;
            head.castShadow = true;
            group.add(head);

            // Eyes - VISIBLE (0.15 radius)
            const eyeGeo = new THREE.SphereGeometry(0.15, 8, 8);
            const eyeMat = new THREE.MeshBasicMaterial({ color: 0x333333 });
            const leftEye = new THREE.Mesh(eyeGeo, eyeMat);
            leftEye.position.set(-0.18, 1.75, 0.4);
            group.add(leftEye);
            const rightEye = new THREE.Mesh(eyeGeo, eyeMat);
            rightEye.position.set(0.18, 1.75, 0.4);
            group.add(rightEye);

            // Halo
            const haloGeo = new THREE.TorusGeometry(0.5, 0.03, 8, 32);
            const haloMat = new THREE.MeshBasicMaterial({ color: 0xFFFF00 });
            const halo = new THREE.Mesh(haloGeo, haloMat);
            halo.position.set(0, 2.5, 0);
            halo.rotation.x = Math.PI / 2;
            group.add(halo);

            // Wings
            const wingGeo = new THREE.SphereGeometry(0.3, 8, 8);
            const wingMat = new THREE.MeshToonMaterial({ color: 0xFFFFFF, transparent: true, opacity: 0.7 });
            const leftWing = new THREE.Mesh(wingGeo, wingMat);
            leftWing.position.set(-0.6, 1.3, 0);
            leftWing.scale.set(1, 0.6, 0.3);
            group.add(leftWing);
            const rightWing = new THREE.Mesh(wingGeo, wingMat);
            rightWing.position.set(0.6, 1.3, 0);
            rightWing.scale.set(1, 0.6, 0.3);
            group.add(rightWing);
        }

        function createDefaultCharacter(group, char) {
            const bodyGeo = new THREE.SphereGeometry(0.4, 16, 16);
            const bodyMat = new THREE.MeshToonMaterial({ color: char.color });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 0.8;
            group.add(body);

            const headGeo = new THREE.SphereGeometry(0.45, 16, 16);
            const headMat = new THREE.MeshToonMaterial({ color: 0xFFE0BD });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 1.8;
            group.add(head);

            // Eyes - VISIBLE (0.15 radius)
            const eyeGeo = new THREE.SphereGeometry(0.15, 8, 8);
            const eyeMat = new THREE.MeshBasicMaterial({ color: 0x333333 });
            const leftEye = new THREE.Mesh(eyeGeo, eyeMat);
            leftEye.position.set(-0.15, 1.8, 0.4);
            group.add(leftEye);
            const rightEye = new THREE.Mesh(eyeGeo, eyeMat);
            rightEye.position.set(0.15, 1.8, 0.4);
            group.add(rightEye);
        }

        function createRelationships() {
            relationships.forEach(rel => {
                const fromChar = characters.find(c => c.id === rel.from);
                const toChar = characters.find(c => c.id === rel.to);
                if (!fromChar || !toChar) return;

                // Colors
                const colors = {
                    best_friend: 0xFF6B6B,
                    unrequited: 0x9B59B6,
                    toxic: 0xFF4500,
                    secret: 0x3498DB,
                    fan: 0x2ECC71,
                    contract: 0x95A5A6,
                };
                const color = colors[rel.type] || 0xFFFFFF;

                // THICK PIPE (radius 0.8 instead of 0.1)
                const pipeRadius = 0.8;
                const startPoint = new THREE.Vector3(
                    fromChar.position.x,
                    0,
                    fromChar.position.z
                );
                const endPoint = new THREE.Vector3(
                    toChar.position.x,
                    0,
                    toChar.position.z
                );
                const direction = new THREE.Vector3().subVectors(endPoint, startPoint);
                const length = direction.length();
                direction.normalize();

                const pipeGeo = new THREE.CylinderGeometry(pipeRadius, pipeRadius, length, 16);
                const pipeMat = new THREE.MeshStandardMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.7,
                    roughness: 0.4,
                    metalness: 0.3,
                });
                const pipe = new THREE.Mesh(pipeGeo, pipeMat);
                pipe.position.copy(startPoint).add(endPoint).multiplyScalar(0.5);
                pipe.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), direction);
                pipe.castShadow = true;
                scene.add(pipe);

                // Arrow
                const arrowLength = 0.8;
                const arrowRadius = 0.25;
                const arrowGeo = new THREE.ConeGeometry(arrowRadius, arrowLength, 16);
                const arrow = new THREE.Mesh(arrowGeo, pipeMat);
                arrow.position.copy(endPoint).sub(direction.clone().multiplyScalar(arrowLength * 0.5));
                arrow.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), direction);
                arrow.castShadow = true;
                scene.add(arrow);

                // Flow particles
                const flowParticles = [];
                const particleCount = 3;
                for (let i = 0; i < particleCount; i++) {
                    const particleGeo = new THREE.SphereGeometry(0.1, 8, 8);
                    const particleMat = new THREE.MeshBasicMaterial({
                        color: color,
                        transparent: true,
                        opacity: 0.9,
                    });
                    const particle = new THREE.Mesh(particleGeo, particleMat);
                    flowParticles.push({
                        mesh: particle,
                        speed: 0.5 + Math.random() * 0.3,
                        offset: i / particleCount,
                    });
                    scene.add(particle);
                }

                relationLines.push({
                    pipe,
                    arrow,
                    flowParticles,
                    startPoint,
                    endPoint,
                    direction,
                });
            });
        }

        function onClick(event) {
            event.preventDefault();
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(characterMeshes, true);
            if (intersects.length > 0) {
                const group = intersects[0].object;
                showInfoPanel(group.userData);
            } else {
                hideInfoPanel();
            }
        }

        function onDoubleClick(event) {
            event.preventDefault();
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(characterMeshes, true);
            if (intersects.length > 0) {
                const group = intersects[0].object;
                // Toggle selection
                if (group.userData.isSelected) {
                    group.userData.isSelected = false;
                    group.userData.isDraggable = false;
                } else {
                    group.userData.isSelected = true;
                    group.userData.isDraggable = true;
                }
            }
        }

        function showInfoPanel(char) {
            document.getElementById('character-name').textContent = char.name;
            document.getElementById('character-role').textContent = char.role;
            document.getElementById('character-personality').textContent = char.type;
            document.getElementById('character-traits').innerHTML = char.traits.map(t =>
                `<span style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">${t}</span>`
            ).join('');

            const healthColors = {
                excellent: '#2ECC71',
                good: '#00BCD4',
                fair: '#F1C40F',
                poor: '#FF6B00',
                critical: '#DC2626',
            };
            const healthIcons = { excellent: '‚úì', good: '‚úì', fair: '!', poor: '‚ö†', critical: 'üî•' };
            const healthColor = healthColors[char.health] || '#999';
            const healthIcon = healthIcons[char.health] || '?';

            document.getElementById('character-health').innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: ${healthColor}; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 14px; color: #fff;">${healthIcon}</span>
                    </div>
                    <span style="font-size: 14px; font-weight: 500;">${char.health}</span>
                </div>
            `;

            if (char.stats) {
                document.getElementById('character-stats').innerHTML = `
                    <div>Lines of Code:</div><div style="font-weight: 500;">${char.stats.lines || 'N/A'}</div>
                    <div>Complexity:</div><div style="font-weight: 500;">${char.stats.complexity || 'N/A'}/10</div>
                `;
            }

            if (char.description) {
                document.getElementById('character-backstory').innerHTML = `
                    <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">DESCRIPTION</div>
                    <div style="font-size: 13px; line-height: 1.6;">${char.description}</div>
                `;
            }

            infoPanel.classList.add('visible');
        }

        function hideInfoPanel() {
            infoPanel.classList.remove('visible');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        let time = 0;
        function animate() {
            requestAnimationFrame(animate);

            const delta = 0.016;
            time += delta;

            // Update flow particles
            relationLines.forEach(line => {
                if (line.flowParticles) {
                    line.flowParticles.forEach(particle => {
                        particle.offset += particle.speed * delta;
                        if (particle.offset > 1) particle.offset = 0;

                        const t = particle.offset;
                        const position = new THREE.Vector3().copy(line.startPoint).lerp(line.endPoint, t);
                        particle.mesh.position.copy(position);
                    });
                }
            });

            controls.update();
            renderer.render(scene, camera);
        }

        // Initialize
        init();
    </script>
</body>
</html>
